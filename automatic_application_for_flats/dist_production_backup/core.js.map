{"version":3,"sources":["../src/core.js"],"names":["modulesDirectoryName","modulesPath","path","join","__dirname","verifyContactData","contactData","minimumRequiredFields","missingRequiredFields","length","Error","process","getBrowser","flatOfferFetchers","intervalBetweenProcessRuns","shouldStop","console","log","fetchFlatOffers","onFlatOffer","bind","flatOffer","haveAppliedForFlatOffer","isAFlatWeCanApplyFor","apply","getFlatOfferFetchers","fileName","fs","readdir","filePath","stats","stat","isDirectory","isJavaScriptFile","basename","startsWith","extname","endsWith","isFile","module","require","fetcher","fetch","push","error","maxColdRentPlusColdServiceCharges","maxWarmServiceCharges","monthlyIncome","coldRent","coldServiceCharges","warmServiceCharges","warmRent","serviceCharges","forPeopleOfAge","area","numberOfRooms","url","includes","totalRent","selfRenovation","Boolean","age","isFlatOfferForSeniorsOnly","requiredMinimumAge","seniorsOnly","flatOffersAppliedTo","registerFlatOfferAsAppliedTo","writeFile","resolve","JSON","stringify"],"mappings":"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","sourcesContent":["import { promises as fs } from 'fs'\nimport path from 'path'\nimport { getMissingFields } from './lib/getMissingFields.js'\nimport { isBoolean } from './lib/isBoolean.js'\nimport { isNumber } from './lib/isNumber.js'\n\nconst modulesDirectoryName = 'modules'\n\nconst modulesPath = path.join(__dirname, modulesDirectoryName)\n\nexport function verifyContactData (contactData) {\n  const minimumRequiredFields = [\n    'title',\n    'firstName',\n    'lastName',\n    'email',\n    'phone',\n    'address',\n    'applicationMessage',\n    'numberOfAdults',\n    'numberOfChildren',\n    'monthlyIncome',\n    'earliestDateToMoveIn',\n    'wbs',\n    'hasPets',\n    'threatenedByLossOfHousing',\n    'firstTimeHousehold',\n    'mBill',\n  ]\n  const missingRequiredFields = getMissingFields(minimumRequiredFields, contactData)\n  if (missingRequiredFields.length >= 1) {\n    throw new Error(`Missing required fields in contact data: ${missingRequiredFields.join(\n      ', ')}`)\n  }\n}\n\nexport async function process (\n  getBrowser,\n  flatOfferFetchers,\n  { intervalBetweenProcessRuns, contactData, shouldStop },\n) {\n  console.log('Fetching flat offers...')\n  await fetchFlatOffers(\n    getBrowser,\n    intervalBetweenProcessRuns,\n    flatOfferFetchers,\n    onFlatOffer.bind(null, getBrowser, contactData),\n    shouldStop,\n  )\n}\n\nasync function onFlatOffer (getBrowser, contactData, flatOffer) {\n  if (!haveAppliedForFlatOffer(flatOffer) &&\n    isAFlatWeCanApplyFor(contactData, flatOffer)) {\n    await apply(getBrowser, contactData, flatOffer)\n  }\n}\n\nexport async function getFlatOfferFetchers () {\n  const flatOfferFetchers = []\n  for (const fileName of await fs.readdir(modulesPath)) {\n    let filePath = path.join(modulesPath, fileName)\n    let stats = await fs.stat(filePath)\n    if (stats.isDirectory()) {\n      filePath = path.join(filePath, 'index.js')\n      stats = await fs.stat(filePath)\n    }\n    if (\n      isJavaScriptFile(filePath) &&\n      !path.basename(fileName).startsWith('_') &&\n      !path.basename(fileName, path.extname(fileName)).endsWith('_test')\n    ) {\n      if (stats.isFile()) {\n        const module = require(filePath)\n        const fetcher = module.fetch\n        if (!fetcher) {\n          throw new Error(`Module \"${filePath}\" has no expected export \"fetch\".`)\n        }\n        if (typeof fetcher !== 'function') {\n          throw new Error(`Module \"${filePath}\" export \"fetch\" has not the expected type \"function\".`)\n        }\n        flatOfferFetchers.push(fetcher)\n      }\n    }\n  }\n  return flatOfferFetchers\n}\n\nasync function fetchFlatOffers (\n  getBrowser,\n  intervalBetweenProcessRuns,\n  flatOfferFetchers,\n  onFlatOffer,\n  shouldStop,\n) {\n  for (const fetch of flatOfferFetchers) {\n    try {\n      await fetch(getBrowser, intervalBetweenProcessRuns, onFlatOffer, shouldStop)\n    } catch (error) {\n      console.error(error)\n    }\n  }\n}\n\n// TODO: Needs unit tests\nexport function isAFlatWeCanApplyFor (contactData, flatOffer) {\n  const maxColdRentPlusColdServiceCharges = 463.65\n  const maxWarmServiceCharges = 76.50\n  const monthlyIncome = 986.15 /* AG2 */\n  return (\n    (\n      (\n        isNumber(flatOffer.coldRent) &&\n        isNumber(flatOffer.coldServiceCharges) &&\n        isNumber(flatOffer.warmServiceCharges) &&\n        flatOffer.coldRent +\n        flatOffer.coldServiceCharges <=\n        maxColdRentPlusColdServiceCharges &&\n        flatOffer.warmServiceCharges <=\n        maxWarmServiceCharges\n      ) ||\n      (\n        isNumber(flatOffer.warmRent) &&\n        flatOffer.warmRent <= maxColdRentPlusColdServiceCharges + maxWarmServiceCharges\n      ) ||\n      (\n        isNumber(flatOffer.coldRent) &&\n        isNumber(flatOffer.serviceCharges) &&\n        flatOffer.coldRent +\n        flatOffer.serviceCharges <=\n        maxColdRentPlusColdServiceCharges +\n        maxWarmServiceCharges\n      )\n    ) &&\n    forPeopleOfAge(flatOffer, 30) &&\n    flatOffer.area <= 50 && // m ** 2\n    flatOffer.numberOfRooms <= 2 &&\n    (\n      (!flatOffer.url.includes('howoge') && !flatOffer.url.includes('degewo')) ||\n      monthlyIncome >= 3 * totalRent(flatOffer) // Haushaltsnettoeinkommen >= 3 * Gesamtmiete\n    ) &&\n    (!isBoolean(flatOffer.selfRenovation) ||\n      flatOffer.selfRenovation ===\n      Boolean(contactData.selfRenovation))\n  )\n}\n\nfunction totalRent (flatOffer) {\n  if (\n    isNumber(flatOffer.coldRent) &&\n    isNumber(flatOffer.coldServiceCharges) &&\n    isNumber(flatOffer.warmServiceCharges)) {\n    return flatOffer.coldRent +\n      flatOffer.coldServiceCharges +\n      flatOffer.warmServiceCharges\n  } else if (isNumber(flatOffer.warmRent)) {\n    return flatOffer.warmRent\n  } else if (\n    isNumber(flatOffer.coldRent) &&\n    isNumber(flatOffer.serviceCharges)\n  ) {\n    return flatOffer.coldRent + flatOffer.serviceCharges\n  }\n}\n\nfunction forPeopleOfAge (flatOffer, age) {\n  return (\n    !isFlatOfferForSeniorsOnly(flatOffer) &&\n    (\n      typeof flatOffer.requiredMinimumAge !== 'number' ||\n      age >= flatOffer.requiredMinimumAge\n    )\n  )\n}\n\nfunction isFlatOfferForSeniorsOnly (flatOffer) {\n  return Boolean(flatOffer.seniorsOnly)\n}\n\nasync function apply (getBrowser, contactData, flatOffer) {\n  console.log('Flat offer that can be applied to: ' + flatOffer.url)\n  /*\n  if (typeof flatOffer.apply === 'function') {\n    console.log('Applying for flat offer: ', flatOffer)\n    await flatOffer.apply(getBrowser, contactData)\n  } else {\n    console.log('Sending notification for flat offer: ', flatOffer)\n    await notify(flatOffer, contactData)\n  }\n  */\n  /*\n  console.log('Sending notification for flat offer: ', flatOffer)\n  await notify(flatOffer, contactData)\n  */\n  /*\n   * await registerFlatOfferAsAppliedTo(flatOffer)\n   */\n}\n\n// IMPROVEMENT: Structure code of haveAppliedForFlatOffer and registerFlatOfferAsAppliedTo like fetchedFlatOffers.js\n// IMPROVEMENT: Save flatOffer data for manual validation (like it is done for fetchedFlatOffers.json)\nfunction haveAppliedForFlatOffer (flatOffer) {\n  // FIXME: User readJSON instead of require\n  const flatOffersAppliedTo = require('../flatOffersAppliedTo.json')\n  return flatOffersAppliedTo.includes(flatOffer.url)\n}\n\nexport async function registerFlatOfferAsAppliedTo (flatOffer) {\n  // FIXME: User readJSON instead of require\n  const flatOffersAppliedTo = require('../flatOffersAppliedTo.json')\n  flatOffersAppliedTo.push(flatOffer.url)\n  await fs.writeFile(\n    path.resolve(__dirname, '..', 'flatOffersAppliedTo.json'),\n    JSON.stringify(flatOffersAppliedTo, null, 2),\n  )\n}\n\nfunction isJavaScriptFile (filePath) {\n  return ['.js', '.mjs', '.cjs'].includes(path.extname(filePath))\n}\n"],"file":"core.js"}